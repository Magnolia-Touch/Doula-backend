// Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CLIENT
  DOULA
  ZONE_MANAGER
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELED
}

enum BookingStatus {
  ACTIVE
  COMPLETED
  CANCELED
}

enum ServiceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum WeekDays {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

//User Model
model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  phone        String?   @unique
  otp          String?
  otpExpiresAt DateTime?
  role         Role
  is_active    Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  zonemanagerprofile ZoneManagerProfile? @relation("UserZoneManagerProfile")
  doulaProfile       DoulaProfile?       @relation("UserDoulaProfile")
  clientProfile      ClientProfile?      @relation("UserClientProfile")
  adminProfile       AdminProfile?       @relation("UserAdminProfile")
  Notification       Notification[]
}

//Zone Manager Profile 
model ZoneManagerProfile {
  id            String   @id @default(uuid())
  user          User?    @relation("UserZoneManagerProfile", fields: [userId], references: [id], onDelete: Cascade)
  userId        String?  @unique
  profile_image String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  managingRegion Region[]

  doulas                   DoulaProfile[]
  notes                    Notes[]
  availableSlotsForMeeting AvailableSlotsForMeeting[]
  Meeting                  Meetings[]
}

// Doula Profile
model DoulaProfile {
  id            String   @id @default(uuid())
  user          User     @relation("UserDoulaProfile", fields: [userId], references: [id], onDelete: Cascade)
  userId        String   @unique
  regionId      String?
  profile_image String?
  description   String?  @db.Text()
  achievements  String?  @db.Text()
  qualification String?  @db.Text()
  yoe           Int?
  languages     Json?
  specialities  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  Region      Region[]             @relation("regions")
  zoneManager ZoneManagerProfile[]

  schedules                ServiceBooking[]
  availableSlotsForMeeting AvailableSlotsForMeeting[]
  Meeting                  Meetings[]
  AvailableSlotsForService AvailableSlotsForService[]
  IntakeForm               IntakeForm[]
  ServicePricing           ServicePricing[]
  Testimonials             Testimonials[]
  Schedules                Schedules[]
  DoulaGallery             DoulaGallery[]
  Certificates             Certificates[]
}

// Client Profile
model ClientProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  is_verified   Boolean  @default(false)
  region        String?
  address       String?
  profile_image String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation("UserClientProfile", fields: [userId], references: [id], onDelete: Cascade)

  intakeForms  IntakeForm[]
  enquiryForms EnquiryForm[]
  bookings     ServiceBooking[]
  Meetings     Meetings[]
  Testimonials Testimonials[]
  Schedules    Schedules[]
}

// Admin Profile
model AdminProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  profile_image String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation("UserAdminProfile", fields: [userId], references: [id], onDelete: Cascade)

  notes                    Notes[]
  availableSlotsForMeeting AvailableSlotsForMeeting[]
  Meeting                  Meetings[]
}

// Enquiry Form
model EnquiryForm {
  id                String    @id @default(uuid())
  name              String
  email             String
  phone             String
  additionalNotes   String?
  meetingsDate      DateTime
  meetingsTimeSlots String
  seviceStartDate   DateTime?
  serviceEndDate    DateTime?
  VisitFrequency    Int?
  serviceTimeSlots  String?
  serviceName       String
  meetingsId        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  regionId  String
  slotId    String
  serviceId String
  clientId  String //remove this line 

  region        Region                   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  slot          AvailableSlotsForMeeting @relation(fields: [slotId], references: [id], onDelete: Cascade)
  service       Service                  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  clientProfile ClientProfile            @relation(fields: [clientId], references: [id], onDelete: Cascade) //remove this line
}

// Regions
model Region {
  id         String   @id @default(uuid())
  regionName String
  pincode    String   @unique
  district   String
  state      String
  country    String
  latitude   String
  longitude  String
  is_active  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  zoneManagerId String?

  zoneManager ZoneManagerProfile? @relation(fields: [zoneManagerId], references: [id], onDelete: SetNull)

  doula          DoulaProfile[]   @relation("regions")
  EnquiryForm    EnquiryForm[]
  ServiceBooking ServiceBooking[]
  IntakeForm     IntakeForm[]
}

// Notes
model Notes {
  id            String   @id @default(uuid())
  remarks       String
  zoneManagerId String?
  adminId       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  zoneManager ZoneManagerProfile? @relation(fields: [zoneManagerId], references: [id], onDelete: Cascade)
  admin       AdminProfile?       @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model AvailableSlotsForMeeting {
  id        String   @id @default(uuid())
  weekday   WeekDays
  availabe  Boolean  @default(true) //can be marked false if on leave or when locked.
  ownerRole Role

  doulaId       String?
  adminId       String?
  zoneManagerId String?

  zoneManager ZoneManagerProfile? @relation(fields: [zoneManagerId], references: [id], onDelete: Cascade)
  doula       DoulaProfile?       @relation(fields: [doulaId], references: [id], onDelete: Cascade)
  admin       AdminProfile?       @relation(fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  EnquiryForm                  EnquiryForm[]
  meetings                     Meetings[]
  AvailableSlotsTimeForMeeting AvailableSlotsTimeForMeeting[]

  @@unique([doulaId, weekday])
  @@unique([adminId, weekday])
  @@unique([zoneManagerId, weekday])
}

model AvailableSlotsTimeForMeeting {
  id        String   @id @default(uuid())
  startTime DateTime @db.Time(0)
  endTime   DateTime @db.Time(0)
  availabe  Boolean  @default(true) //can be marked false if on leave or when locked.
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dateId String

  date       AvailableSlotsForMeeting @relation(fields: [dateId], references: [id], onDelete: Cascade)
  Meetings   Meetings?                @relation(fields: [meetingsId], references: [id])
  meetingsId String?
}

model Meetings {
  id          String        @id @default(uuid())
  link        String
  status      MeetingStatus
  startTime   DateTime      @db.Time(0)
  endTime     DateTime      @db.Time(0)
  date        DateTime
  serviceName String
  remarks     String?

  bookedById String // customer ID
  bookedBy   ClientProfile @relation(fields: [bookedById], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  cancelledAt   DateTime?
  rescheduledAt DateTime?

  availableSlotsForMeetingId String?
  zoneManagerProfileId       String?
  doulaProfileId             String?
  adminProfileId             String?
  serviceId                  String?

  AvailableSlotsForMeeting     AvailableSlotsForMeeting?      @relation(fields: [availableSlotsForMeetingId], references: [id], onDelete: Cascade)
  ZoneManagerProfile           ZoneManagerProfile?            @relation(fields: [zoneManagerProfileId], references: [id], onDelete: Cascade)
  DoulaProfile                 DoulaProfile?                  @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
  AdminProfile                 AdminProfile?                  @relation(fields: [adminProfileId], references: [id], onDelete: Cascade)
  Service                      Service?                       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  AvailableSlotsTimeForMeeting AvailableSlotsTimeForMeeting[]
}

model AvailableSlotsForService {
  id        String   @id @default(uuid())
  weekday   WeekDays
  availabe  Boolean  @default(true) //can be marked false if on leave or when locked.
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  doulaId   String

  doula                        DoulaProfile                   @relation(fields: [doulaId], references: [id], onDelete: Cascade)
  IntakeForm                   IntakeForm[]
  AvailableSlotsTimeForService AvailableSlotsTimeForService[]
  ServiceBooking               ServiceBooking[]

  // Prevent duplicates for the same owner for same day/time
  @@unique([doulaId, weekday]) //creates a compostie unique constraint
}

model AvailableSlotsTimeForService {
  id        String   @id @default(uuid())
  startTime DateTime @db.Time(0)
  endTime   DateTime @db.Time(0)
  availabe  Boolean  @default(true) //can be marked false if on leave or when locked.
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  formId    String?
  bookingId String?
  dateId    String

  date           AvailableSlotsForService @relation(fields: [dateId], references: [id], onDelete: Cascade)
  IntakeForm     IntakeForm?              @relation(fields: [formId], references: [id])
  ServiceBooking ServiceBooking?          @relation(fields: [bookingId], references: [id])
}

// Intake Form
model IntakeForm {
  id        String   @id @default(uuid())
  startDate DateTime @default(now())
  endDate   DateTime @default(now())
  location  String?

  //use these optional data if the service location is different
  name    String?
  email   String?
  phone   String?
  address String  @db.Text

  regionId         String
  servicePricingId String
  doulaProfileId   String
  clientId         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service       ServicePricing                 @relation(fields: [servicePricingId], references: [id])
  clientProfile ClientProfile                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  region        Region                         @relation(fields: [regionId], references: [id], onDelete: Cascade)
  DoulaProfile  DoulaProfile                   @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
  slotTime      AvailableSlotsTimeForService[]
  slot          AvailableSlotsForService[]
}

// Service Booking
model ServiceBooking {
  id             String        @id @default(uuid())
  startDate      DateTime      @default(now())
  endDate        DateTime      @default(now())
  paymentDetails Json?
  status         BookingStatus @default(ACTIVE)

  regionId         String
  servicePricingId String
  doulaProfileId   String
  clientId         String

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  DoulaProfile             DoulaProfile                   @relation(fields: [doulaProfileId], references: [id])
  service                  ServicePricing                 @relation(fields: [servicePricingId], references: [id])
  client                   ClientProfile                  @relation(fields: [clientId], references: [id])
  region                   Region                         @relation(fields: [regionId], references: [id])
  slot                     AvailableSlotsTimeForService[]
  AvailableSlotsForService AvailableSlotsForService[]
  schedules                Schedules[]
}

// Service Model
model Service {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text()
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ServicePricing ServicePricing[]
  Meeting        Meetings[]
  EnquiryForm    EnquiryForm[]
}

model ServicePricing {
  id             String  @id @default(uuid())
  serviceId      String
  doulaProfileId String
  price          Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service        Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  DoulaProfile   DoulaProfile     @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
  IntakeForm     IntakeForm[]
  ServiceBooking ServiceBooking[]

  //add images adding option here.
  Testimonials Testimonials[]
  Schedules    Schedules[]
}

model Testimonials {
  id             String   @id @default(uuid())
  doulaProfileId String
  serviceId      String
  ratings        Int
  reviews        String
  clientId       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  DoulaProfile   DoulaProfile   @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
  ServicePricing ServicePricing @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  client         ClientProfile  @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Schedules {
  id        String        @id @default(uuid())
  date      DateTime      @db.Date
  startTime DateTime
  endTime   DateTime
  status    ServiceStatus @default(PENDING)

  doulaProfileId String
  serviceId      String
  clientId       String
  bookingId      String

  DoulaProfile   DoulaProfile   @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
  ServicePricing ServicePricing @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceBooking ServiceBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client         ClientProfile  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id          String    @id @default(uuid())
  userId      String?
  title       String
  body        String
  icon        String?
  isRead      Boolean   @default(false)
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  channels    Json?

  // maybe soft delete in future
  deletedAt DateTime?

  user User? @relation(fields: [userId], references: [id])
}

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String
  createdAt DateTime @default(now())
}

model DoulaGallery {
  id             String   @id @default(uuid())
  doulaProfileId String
  url            String
  altText        String?
  createdAt      DateTime @default(now())

  doulaProfile DoulaProfile @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
}

model Certificates {
  id             String @id @default(uuid())
  name           String
  issuedBy       String @default("Unknown")
  year           String @default("0000")
  doulaProfileId String

  doulaProfile DoulaProfile @relation(fields: [doulaProfileId], references: [id], onDelete: Cascade)
}
